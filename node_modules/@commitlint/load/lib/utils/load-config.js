"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDynamicAwaitConfig = exports.isDynamicAwaitSupported = exports.loadConfig = void 0;
const cosmiconfig_1 = require("cosmiconfig");
const cosmiconfig_typescript_loader_1 = require("cosmiconfig-typescript-loader");
const path_1 = __importDefault(require("path"));
const moduleName = 'commitlint';
async function loadConfig(cwd, configPath) {
    let tsLoaderInstance;
    const tsLoader = (...args) => {
        if (!tsLoaderInstance) {
            tsLoaderInstance = (0, cosmiconfig_typescript_loader_1.TypeScriptLoader)();
        }
        return tsLoaderInstance(...args);
    };
    const { searchPlaces, loaders } = (0, exports.getDynamicAwaitConfig)();
    const explorer = (0, cosmiconfig_1.cosmiconfig)(moduleName, {
        searchPlaces: [
            // cosmiconfig overrides default searchPlaces if any new search place is added (For e.g. `*.ts` files),
            // we need to manually merge default searchPlaces from https://github.com/davidtheclark/cosmiconfig#searchplaces
            'package.json',
            `.${moduleName}rc`,
            `.${moduleName}rc.json`,
            `.${moduleName}rc.yaml`,
            `.${moduleName}rc.yml`,
            `.${moduleName}rc.js`,
            `.${moduleName}rc.cjs`,
            `${moduleName}.config.js`,
            `${moduleName}.config.cjs`,
            // files supported by TypescriptLoader
            `.${moduleName}rc.ts`,
            `.${moduleName}rc.cts`,
            `${moduleName}.config.ts`,
            `${moduleName}.config.cts`,
            ...(searchPlaces || []),
        ],
        loaders: Object.assign({ '.ts': tsLoader, '.cts': tsLoader }, (loaders || {})),
    });
    const explicitPath = configPath ? path_1.default.resolve(cwd, configPath) : undefined;
    const explore = explicitPath ? explorer.load : explorer.search;
    const searchPath = explicitPath ? explicitPath : cwd;
    const local = await explore(searchPath);
    if (local) {
        return local;
    }
    return null;
}
exports.loadConfig = loadConfig;
// See the following issues for more context:
//  - Issue: https://github.com/nodejs/node/issues/40058
//  - Resolution: https://github.com/nodejs/node/pull/48510 (Node v20.8.0)
const isDynamicAwaitSupported = () => {
    const [major, minor] = process.version
        .replace('v', '')
        .split('.')
        .map((val) => parseInt(val));
    return major >= 20 && minor >= 8;
};
exports.isDynamicAwaitSupported = isDynamicAwaitSupported;
// If dynamic await is supported (Node >= v20.8.0), support mjs config.
// Otherwise, don't support mjs and use synchronous js/cjs loaders.
const getDynamicAwaitConfig = () => (0, exports.isDynamicAwaitSupported)()
    ? {
        searchPlaces: [`.${moduleName}rc.mjs`, `${moduleName}.config.mjs`],
        loaders: {},
    }
    : {
        searchPlaces: [],
        loaders: {
            '.cjs': cosmiconfig_1.defaultLoadersSync['.cjs'],
            '.js': cosmiconfig_1.defaultLoadersSync['.js'],
        },
    };
exports.getDynamicAwaitConfig = getDynamicAwaitConfig;
//# sourceMappingURL=load-config.js.map